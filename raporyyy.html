<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Kayƒ±t Raporu</title>
  <style>
    .menu {
      text-align: center;
      margin-bottom: 20px;
      background: #007acc;
      padding: 10px;
      border-radius: 8px;
    }
    .menu a {
      color: white;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
      font-size: 18px;
      transition: all 0.3s ease;
    }
    .menu a:hover {
      color: #ffeb3b;
      transform: scale(1.1);
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
      font-size: 16px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    label, input {
      display: block;
      margin: 10px auto;
      text-align: center;
    }

    input {
      padding: 10px;
      width: 90%;
      max-width: 500px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      text-transform: uppercase;
    }

    #summary {
      text-align: center;
      margin: 15px;
      font-weight: bold;
      color: #555;
    }

    .limit-info {
      text-align: center;
      font-size: 12px;
      color: #888;
      margin-bottom: 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
      font-size: 14px;
      text-transform: uppercase;
    }

    th {
      background: #007acc;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th.fiyat, td.fiyat {
      text-align: right;
    }

    tr:nth-child(even) {
      background: #f2f2f2;
    }

    tr:hover {
      background: #e6f7ff;
    }

    .highlight {
      background-color: yellow;
      font-weight: bold;
      color: black;
    }

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead tr {
        display: none;
      }
      tr {
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #fff;
        padding: 12px;
      }
      td {
        border: none;
        display: flex;
        justify-content: space-between;
        padding: 10px;
        font-size: 18px;
        border-bottom: 1px solid #eee;
      }
      td:last-child { border-bottom: none; }
      td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #007acc;
        margin-right: 10px;
      }
      input {
        width: 100%;
      }
    }

    .delete-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .delete-btn:hover { background: #c0392b; }
    .delete-btn:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>

  <nav class="menu">
    <a href="forum.html">üìù Kayƒ±t Giri≈ü</a>
    <a href="rapor.html">üìä Rapor</a>
  </nav>

  <h2>Kayƒ±t Raporu</h2>

  <div id="summary">Veriler Y√ºkleniyor...</div>
  <div class="limit-info" id="limitLabel">Son 100 kayƒ±t g√∂steriliyor. T√ºm√ºn√º g√∂rmek i√ßin arama yapƒ±n.</div>

  <label for="searchInput">Ara:</label>
  <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="ƒ∞sim, IMEI veya Tarih yaz...">

  <table id="raporTable">
    <thead>
      <tr>
        <th>AD SOYAD</th>
        <th>MARKA</th>
        <th>MODEL</th>
        <th>IMEI</th>
        <th>ƒ∞≈ûLEM</th>
        <th class="fiyat">Fƒ∞YAT</th>
        <th>TARƒ∞H</th>
        <th>NOT</th>
        <th>Sƒ∞L</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzb4SWk4Ihk8rMLIyNn6KhyNZU1bf0RCQJc84ML6FVqm3lA9XQgFp0Yg9R0Zgs6kzfLnQ/exec"; 
    let globalData = [];
    const ROW_LIMIT = 100; // ƒ∞lk a√ßƒ±lƒ±≈üta ka√ß satƒ±r g√∂sterilsin?

    async function loadReport() {
      try {
        const res = await fetch(WEBAPP_URL);
        globalData = await res.json();
        
        // Ba≈ülangƒ±√ßta sadece limit kadarƒ±nƒ± g√∂ster (En g√ºncel olanlar)
        const initialShow = globalData.slice().reverse().slice(0, ROW_LIMIT);
        renderTable(initialShow);
        updateSummary(globalData);
      } catch (err) {
        console.error("Hata:", err);
        document.getElementById("summary").textContent = "Baƒülantƒ± Hatasƒ±!";
      }
    }

    function formatTarih(val) {
      if (!val) return "";
      let d = new Date(val);
      if (isNaN(d.getTime())) return String(val).toUpperCase(); 
      return d.toLocaleDateString("tr-TR", { day:"2-digit", month:"2-digit", year:"numeric" });
    }

    function renderTable(data, query = "") {
      const tbody = document.querySelector("#raporTable tbody");
      tbody.innerHTML = "";
      
      const columns = ["AD SOYAD", "MARKA", "MODEL", "IMEI", "ƒ∞≈ûLEM", "Fƒ∞YAT", "TARƒ∞H", "NOT"];
      const fragment = document.createDocumentFragment(); // Performans i√ßin fragment kullanƒ±mƒ±

      data.forEach(row => {
        const tr = document.createElement("tr");
        
        columns.forEach(col => {
          let cellVal = row[col] ? String(row[col]) : "";
          if (col === "TARƒ∞H") cellVal = formatTarih(cellVal);

          const displayVal = cellVal.toUpperCase();
          let finalHTML = displayVal;

          if (query) {
            const regex = new RegExp(`(${escapeRegExp(query)})`, "gi");
            finalHTML = displayVal.replace(regex, `<span class="highlight">$1</span>`);
          }

          const td = document.createElement("td");
          td.className = col === "Fƒ∞YAT" ? "fiyat" : "";
          td.setAttribute("data-label", col);
          td.innerHTML = finalHTML;
          tr.appendChild(td);
        });

        // Sil Butonu
        const tdSil = document.createElement("td");
        tdSil.setAttribute("data-label", "Sƒ∞L");
        const imei = String(row["IMEI"] || "");
        tdSil.innerHTML = `<button class="delete-btn" onclick="handleDelete(this, '${encodeURIComponent(imei)}')">Sil</button>`;
        tr.appendChild(tdSil);
        
        fragment.appendChild(tr);
      });
      
      tbody.appendChild(fragment);
    }

    function filterTable() {
      const query = document.getElementById("searchInput").value.trim().toLowerCase();
      const limitLabel = document.getElementById("limitLabel");

      if (query === "") {
        // Arama bo≈üsa son 100 kayda geri d√∂n
        const initialShow = globalData.slice().reverse().slice(0, ROW_LIMIT);
        renderTable(initialShow);
        limitLabel.style.display = "block";
      } else {
        // Arama varsa T√úM veride ara
        const filtered = globalData.slice().reverse().filter(row => {
          const searchableText = [
            String(row["AD SOYAD"] || ""),
            String(row["MARKA"] || ""),
            String(row["MODEL"] || ""),
            String(row["IMEI"] || ""),
            String(row["ƒ∞≈ûLEM"] || ""),
            formatTarih(row["TARƒ∞H"]),
            String(row["NOT"] || "")
          ].join(" ").toLowerCase();
          return searchableText.includes(query);
        });
        renderTable(filtered, query);
        limitLabel.style.display = "none";
      }
      updateSummary(globalData); // √ñzet her zaman t√ºm veriyi yansƒ±tsƒ±n
    }

    async function handleDelete(btn, encodedImei) {
      const imei = decodeURIComponent(encodedImei);
      btn.innerText = "...";
      btn.disabled = true;

      try {
        await fetch(WEBAPP_URL, {
          method: "POST",
          mode: "no-cors", 
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "delete", imei: imei })
        });

        // Listeyi yerel olarak g√ºncelle (Tekrar fetch yapmadan hƒ±z kazandƒ±rƒ±r)
        globalData = globalData.filter(r => String(r["IMEI"]) !== imei);
        filterTable(); // Tabloyu mevcut duruma g√∂re tazele
      } catch (err) {
        alert("Hata!");
        btn.innerText = "Sil";
        btn.disabled = false;
      }
    }

    function updateSummary(data) {
      const toplam = data.length;
      const alinan = data.filter(r => String(r["ƒ∞≈ûLEM"] || "").toLowerCase().includes("al")).length;
      const satilan = data.filter(r => String(r["ƒ∞≈ûLEM"] || "").toLowerCase().includes("sat")).length;
      document.getElementById("summary").textContent = `Toplam Kayƒ±t: ${toplam} | Alƒ±nan: ${alinan} | Satƒ±lan: ${satilan}`;
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    loadReport();
  </script>
</body>
</html>
