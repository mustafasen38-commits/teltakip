<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Kayƒ±t Raporu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 15px; background: #f0f2f5; color: #333; }
    input, textarea, select { text-transform: uppercase; }

    /* --- √úst Men√º --- */
    .menu { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; background: #007acc; padding: 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .menu a { color: white; text-decoration: none; font-weight: bold; font-size: 16px; padding: 6px 12px; border-radius: 6px; transition: 0.3s; }
    .menu a:hover { background: rgba(255, 255, 255, 0.2); color: #ffeb3b; }

    h2 { text-align: center; color: #007acc; margin-bottom: 10px; }
    #summary { text-align: center; background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 5px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #007acc; }
    #limitInfo { text-align: center; font-size: 13px; color: #666; margin-bottom: 15px; font-style: italic; }

    /* Arama √áubuƒüu */
    .search-container { max-width: 600px; margin: 0 auto 10px auto; }
    input#searchInput { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 25px; font-size: 16px; outline: none; transition: 0.3s; }

    /* --- Filtre ve Yazdƒ±r Butonlarƒ± Konteynƒ±rƒ± --- */
    .filter-container { max-width: 600px; margin: 0 auto 20px auto; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
    .f-btn { border: none; padding: 8px 14px; border-radius: 18px; cursor: pointer; font-weight: bold; font-size: 11px; color: white; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
    .btn-tumu { background: #6c757d; }
    .btn-stok { background: #f39c12; }
    .btn-bugun { background: #9b59b6; }
    .btn-alinan { background: #3498db; }
    .btn-satilan { background: #e74c3c; }
    .btn-yazdir { background: #27ae60; }
    .active-filter { outline: 3px solid #333; transform: scale(0.95); }

    /* --- Tablo Tasarƒ±mƒ± --- */
    table { border-collapse: collapse; width: 100%; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
    th { background: #007acc; color: white; letter-spacing: 0.5px; }
    .fiyat-sutun { font-weight: bold; color: #2ecc71; text-align: right; }
    mark { background-color: #fff176; color: #000; padding: 0 2px; border-radius: 3px; }

    /* --- MODAL STƒ∞LLERƒ∞ --- */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); }
    .modal-content { background: #fff; margin: 2% auto; padding: 0; border-radius: 15px; width: 95%; max-width: 550px; overflow: hidden; }
    .modal-header { background: #007acc; color: white; padding: 15px 20px; font-size: 18px; font-weight: bold; display: flex; justify-content: space-between; }
    .modal-body { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-height: 75vh; overflow-y: auto; }
    .full-row { grid-column: span 2; }
    .input-group { display: flex; flex-direction: column; position: relative; }
    .input-group label { font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; }
    .input-group input, .input-group select, .input-group textarea { padding: 10px; border: 1.5px solid #e1e5eb; border-radius: 8px; font-size: 15px; background: #f9fbff; }
    .modal-footer { background: #f9f9f9; padding: 15px 20px; display: flex; gap: 10px; border-top: 1px solid #eee; }
    .save-btn { background: #2ecc71; color: white; border: none; padding: 12px; flex: 2; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .cancel-btn { background: #e0e0e0; color: #333; border: none; padding: 12px; flex: 1; border-radius: 8px; cursor: pointer; font-weight: bold; }

    @media (max-width: 850px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { display: none; }
      tr { margin-bottom: 15px; border-radius: 12px; background: #fff; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
      td { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f9f9f9; padding: 10px 5px; text-align: right; }
      td::before { content: attr(data-label); font-weight: 700; color: #007acc; font-size: 11px; text-align: left; flex: 1; }
    }
  </style>
</head>
<body>

  <nav class="menu">
    <a href="forum.html">üìù Kayƒ±t Giri≈ü</a>
    <a href="rapor.html" style="border-bottom: 2px solid #ffeb3b;">üìä Rapor</a>
  </nav>

  <h2>Kayƒ±t Raporu</h2>
  <div id="summary">Y√ºkleniyor...</div>
  <div id="limitInfo">...</div>

  <div class="search-container">
    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="ƒ∞Sƒ∞M, IMEI VEYA TARƒ∞H ARA...">
  </div>

  <div class="filter-container">
    <button class="f-btn btn-tumu active-filter" onclick="setFilter('tumu', this)">üìã T√úM√ú</button>
    <button class="f-btn btn-stok" onclick="setFilter('stok', this)">üì¶ STOK</button>
    <button class="f-btn btn-bugun" onclick="setFilter('bugun', this)">üìÖ BUG√úN</button>
    <button class="f-btn btn-alinan" onclick="setFilter('alinan', this)">üì• ALIM</button>
    <button class="f-btn btn-satilan" onclick="setFilter('satilan', this)">üì§ SATI≈û</button>
    <button class="f-btn btn-yazdir" onclick="yazdirTablo()">üñ®Ô∏è YAZDIR</button>
  </div>

  <table id="raporTable">
    <thead>
      <tr>
        <th>AD SOYAD</th><th>MARKA</th><th>MODEL</th><th>IMEI</th><th>ƒ∞≈ûLEM</th><th>Fƒ∞YAT</th><th>TARƒ∞H</th><th>NOT</th><th>TEL</th><th>TC</th><th>ƒ∞≈ûLEM</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header"><span>‚öôÔ∏è KAYIT D√úZENLE</span><span style="cursor:pointer" onclick="closeModal()">&times;</span></div>
      <div class="modal-body">
        <input type="hidden" id="oldImei">
        <div class="input-group full-row"><label>AD SOYAD</label><input type="text" id="editAd"></div>
        <div class="input-group"><label>MARKA</label><input type="text" id="editMarka"></div>
        <div class="input-group"><label>MODEL</label><input type="text" id="editModel"></div>
        <div class="input-group"><label>IMEI NUMARASI</label><input type="text" id="editImei" maxlength="15"></div>
        <div class="input-group"><label>ƒ∞≈ûLEM T√úR√ú</label><select id="editIslem"><option value="ALINDI">ALINDI</option><option value="SATILDI">SATILDI</option></select></div>
        <div class="input-group"><label>Fƒ∞YAT (TL)</label><input type="text" id="editFiyat"></div>
        <div class="input-group"><label>CEP TELEFONU</label><input type="tel" id="editTel"></div>
        <div class="input-group full-row"><label>TC Kƒ∞MLƒ∞K NO</label><input type="number" id="editTc"></div>
        <div class="input-group full-row"><label>NOTLAR</label><textarea id="editNot" rows="3"></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="save-btn" onclick="submitEdit()">G√úNCELLE</button>
        <button class="cancel-btn" onclick="closeModal()">ƒ∞PTAL</button>
      </div>
    </div>
  </div>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzb4SWk4Ihk8rMLIyNn6KhyNZU1bf0RCQJc84ML6FVqm3lA9XQgFp0Yg9R0Zgs6kzfLnQ/exec"; 
    let globalData = [];
    let currentFilter = 'tumu';
    const MAX_VISIBLE = 100;

    async function loadReport() {
      try {
        const res = await fetch(WEBAPP_URL);
        globalData = await res.json();
        filterTable();
      } catch (err) { document.getElementById("summary").textContent = "Veri y√ºklenemedi!"; }
    }

    function setFilter(type, btn) {
      currentFilter = type;
      document.querySelectorAll('.f-btn').forEach(b => b.classList.remove('active-filter'));
      btn.classList.add('active-filter');
      filterTable();
    }

    function filterTable() {
      const input = document.getElementById("searchInput");
      const trMap = { 'ƒ∞': 'i', 'I': 'ƒ±', '≈û': 's', 'ƒû': 'g', '√ú': 'u', '√ñ': 'o', '√á': 'c' };
      const normalize = (str) => str.toString().toUpperCase().replace(/[ƒ∞I≈ûƒû√ú√ñ√á]/g, m => trMap[m] || m).toLowerCase();
      const query = normalize(input.value.trim());
      
      const satilanImeiler = new Set();
      globalData.forEach(r => {
        if ((r["ƒ∞≈ûLEM"] || "").toUpperCase().includes("SAT")) satilanImeiler.add((r["IMEI"] || "").toString().trim());
      });

      const bugunStr = new Date().toLocaleDateString("tr-TR");
      let allData = globalData.slice().reverse();

      let filtered = allData.filter(row => {
        const islem = (row["ƒ∞≈ûLEM"] || "").toUpperCase();
        const imei = (row["IMEI"] || "").toString().trim();
        const rowDate = row["TARƒ∞H"] ? new Date(row["TARƒ∞H"]).toLocaleDateString("tr-TR") : "-";

        if (currentFilter === 'stok') {
          if (islem.includes("SAT")) return false;
          if (imei !== "" && imei !== "-" && satilanImeiler.has(imei)) return false;
        } 
        else if (currentFilter === 'bugun' && rowDate !== bugunStr) return false;
        else if (currentFilter === 'alinan' && !islem.includes("AL")) return false;
        else if (currentFilter === 'satilan' && !islem.includes("SAT")) return false;

        if (query === "") return true;
        return Object.keys(row).some(key => {
          let val = row[key] ? row[key].toString() : "";
          if (key.toUpperCase() === "TARƒ∞H" && val !== "-") val = new Date(val).toLocaleDateString("tr-TR");
          return normalize(val).includes(query);
        });
      });

      let displayData = (query === "" && currentFilter === 'tumu') ? filtered.slice(0, MAX_VISIBLE) : filtered;
      renderTable(displayData, input.value.trim());
      document.getElementById("limitInfo").innerHTML = `<b>${filtered.length}</b> kayƒ±t listelendi.`;
      updateSummary(globalData);
    }

    function renderTable(data, query = "") {
      const tbody = document.querySelector("#raporTable tbody");
      tbody.innerHTML = "";
      const cols = ["AD SOYAD", "MARKA", "MODEL", "IMEI", "ƒ∞≈ûLEM", "Fƒ∞YAT", "TARƒ∞H", "NOT", "TEL", "TC"];
      
      data.forEach(row => {
        const tr = document.createElement("tr");
        cols.forEach(col => {
          let val = row[col] || "-";
          if (col === "TARƒ∞H" && val !== "-") val = new Date(val).toLocaleDateString("tr-TR");
          const td = document.createElement("td");
          td.setAttribute("data-label", col);
          let txt = val.toString().toUpperCase();

          if (query) {
            const regex = new RegExp(`(${query.toUpperCase()})`, "g");
            td.innerHTML = txt.replace(regex, "<mark>$1</mark>");
          } else { td.innerText = txt; }
          
          if (col === "Fƒ∞YAT") td.className = "fiyat-sutun";
          tr.appendChild(td);
        });

        const rowDataStr = encodeURIComponent(JSON.stringify(row));
        const tdAks = document.createElement("td");
        tdAks.setAttribute("data-label", "ƒ∞≈ûLEM");
        tdAks.innerHTML = `<div style="display:flex;gap:5px"><button onclick='openModal("${rowDataStr}")' style="background:#ffa502;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer">D√úZENLE</button><button onclick="handleDelete('${encodeURIComponent(row["IMEI"] || "")}')" style="background:#ff4757;color:white;border:none;padding:8px;border-radius:5px;cursor:pointer">Sƒ∞L</button></div>`;
        tr.appendChild(tdAks);
        tbody.appendChild(tr);
      });
    }

    function yazdirTablo() {
      const table = document.getElementById("raporTable").cloneNode(true);
      const rows = table.querySelectorAll("tr");
      rows.forEach(row => { if (row.lastElementChild) row.removeChild(row.lastElementChild); });

      const win = window.open("", "", "height=700,width=1000");
      win.document.write("<html><head><title>Yazdƒ±r</title>");
      win.document.write("<style>table{border-collapse:collapse;width:100%;font-family:sans-serif;} th,td{border:1px solid #000;padding:6px;font-size:10px;text-align:left;} th{background:#eee;}</style>");
      win.document.write("</head><body><h2 style='text-align:center'>KAYIT RAPORU</h2>");
      win.document.write(table.outerHTML);
      win.document.write("</body></html>");
      win.document.close();
      win.print();
    }

    function updateSummary(data) {
      let a = 0, s = 0;
      data.forEach(r => {
        let i = (r["ƒ∞≈ûLEM"] || "").toUpperCase();
        if (i.includes("AL")) a++; else if (i.includes("SAT")) s++;
      });
      document.getElementById("summary").textContent = `TOPLAM: ${data.length} | ALINAN: ${a} | SATILAN: ${s}`;
    }

    function openModal(enc) {
      const r = JSON.parse(decodeURIComponent(enc));
      document.getElementById("oldImei").value = r["IMEI"] || "";
      document.getElementById("editAd").value = r["AD SOYAD"] || "";
      document.getElementById("editMarka").value = r["MARKA"] || "";
      document.getElementById("editModel").value = r["MODEL"] || "";
      document.getElementById("editImei").value = r["IMEI"] || "";
      document.getElementById("editIslem").value = (r["ƒ∞≈ûLEM"] || "ALINDI").toUpperCase().includes("SAT") ? "SATILDI" : "ALINDI";
      document.getElementById("editFiyat").value = r["Fƒ∞YAT"] || "";
      document.getElementById("editNot").value = r["NOT"] || "";
      document.getElementById("editTel").value = r["TEL"] || "";
      document.getElementById("editTc").value = r["TC"] || "";
      document.getElementById("editModal").style.display = "block";
    }

    function closeModal() { document.getElementById("editModal").style.display = "none"; }

    async function submitEdit() {
      const b = document.querySelector(".save-btn");
      b.innerText = "ƒ∞≈ûLENƒ∞YOR..."; b.disabled = true;
      const p = {
        action: "edit",
        oldImei: document.getElementById("oldImei").value,
        adSoyad: document.getElementById("editAd").value,
        marka: document.getElementById("editMarka").value,
        model: document.getElementById("editModel").value,
        imei: document.getElementById("editImei").value,
        islem: document.getElementById("editIslem").value,
        fiyat: document.getElementById("editFiyat").value,
        not: document.getElementById("editNot").value,
        tel: document.getElementById("editTel").value,
        tc: document.getElementById("editTc").value
      };
      await fetch(WEBAPP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(p) });
      location.reload(); 
    }

    async function handleDelete(imei) {
      if(confirm("Bu kaydƒ± silmek istediƒüinize emin misiniz?")) {
        await fetch(WEBAPP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "delete", imei: decodeURIComponent(imei) }) });
        location.reload();
      }
    }

    loadReport();
  </script>
</body>
</html>
